#!/bin/bash
set -e

SCRIPT_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
SERVER_NAME="$(basename "$(dirname "$SCRIPT_DIR")")"
RAMDISK_PATH="/mnt/ramdisk/${SERVER_NAME}_world"
RAID_PATH="/mnt/raid/minecraft/${SERVER_NAME}/world"

echo "Ì†ΩÌªë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${SERVER_NAME}"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É–Ω–∫—Ç–∞ 1 —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Docker
if command -v docker &> /dev/null; then
    echo "[1/3] –û—Å—Ç–∞–Ω–æ–≤–∫–∞ Docker-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞..."
    docker-compose -f "${SCRIPT_DIR}/docker-compose.yml" down
else
    echo "[1/3] –ü—Ä–æ–ø—É—Å–∫: Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—É–Ω–∫—Ç–∞ 2 —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç RAMDISK_PATH
if [ -d "$RAMDISK_PATH" ]; then
    echo "[2/3] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–∏—Ä–∞ –∏–∑ RAM –Ω–∞ RAID..."
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ RAM-–¥–∏—Å–∫–∞
    if [ -z "$(ls -A "$RAMDISK_PATH")" ]; then
        echo "‚ö†Ô∏è RAM-–¥–∏—Å–∫ –ø—É—Å—Ç. –ü—Ä–æ–ø—É—Å–∫ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è."
    else
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–π –ø–∞–ø–∫–∏
        if ! sudo mkdir -p "$RAID_PATH" 2>/dev/null; then
            echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Ü–µ–ª–µ–≤—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é $RAID_PATH"
            exit 1
        fi

        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å
        if [ ! -w "$RAID_PATH" ]; then
            echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–ø–∏—Å—å –≤ $RAID_PATH"
            exit 1
        fi

        # –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        echo "Ì†ΩÌ¥Ñ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ $RAMDISK_PATH –≤ $RAID_PATH"
        if sudo rsync -a --delete --checksum "${RAMDISK_PATH}/" "${RAID_PATH}/"; then
            echo "‚úÖ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
            # –§–∏–∫—Å –ø—Ä–∞–≤
            sudo chown -R "$(id -u):$(id -g)" "$RAID_PATH"
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏
            if diff -r "$RAMDISK_PATH" "$RAID_PATH" &>/dev/null; then
                echo "Ì†ΩÌ¥ç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏: OK"
            else
                echo "‚ùå –û—à–∏–±–∫–∞: –†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ –≤ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è!"
                exit 1
            fi
        else
            echo "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö!"
            exit 1
        fi
    fi
else
    echo "[2/3] –ü—Ä–æ–ø—É—Å–∫: RAM-–¥–∏—Å–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω (${RAMDISK_PATH})"
fi

# –ü—É–Ω–∫—Ç 3 –≤—Å–µ–≥–¥–∞ –ø—ã—Ç–∞–µ—Ç—Å—è —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, –µ—Å–ª–∏ —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω
echo "[3/3] –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ RAM-–¥–∏—Å–∫–∞..."
if mountpoint -q "$RAMDISK_PATH"; then
    sudo umount "$RAMDISK_PATH"
    echo "‚úÖ RAM-–¥–∏—Å–∫ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω"
else
    echo "‚ÑπÔ∏è RAM-–¥–∏—Å–∫ –Ω–µ –±—ã–ª —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º"
fi

echo -e "\n‚úÖ –°–µ—Ä–≤–µ—Ä \e[1;32m${SERVER_NAME}\e[0m –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
echo "Ì†ºÌºç –ú–∏—Ä —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤: ${RAID_PATH}"